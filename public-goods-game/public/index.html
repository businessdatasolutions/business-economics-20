<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Public Goods Game</title>
    <!-- Link to Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Link to Socket.IO client library -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
      /* Simple spinner */
      .loader {
        border: 4px solid #f3f3f3; /* Light grey */
        border-top: 4px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        display: inline-block; /* To control positioning */
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Hide number input arrows */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield; /* Firefox */
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div
      id="app-container"
      class="bg-white p-6 md:p-8 rounded-lg shadow-lg w-full max-w-xl mx-auto"
    >
      <!-- ===== Initial View: Role Selection ===== -->
      <div
        id="role-selection"
        class="text-center"
      >
        <h1 class="text-2xl font-bold mb-6 text-gray-700">Public Goods Game</h1>
        <button
          id="join-instructor"
          class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded mr-4 transition duration-150"
        >
          I am the Instructor
        </button>
        <button
          id="join-student"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150"
        >
          I am a Student
        </button>
        <p
          id="connection-status"
          class="mt-4 text-sm text-gray-500"
        >
          Connecting...
        </p>
      </div>

      <!-- ===== Instructor View: Setup ===== -->
      <div
        id="instructor-setup"
        class="hidden"
      >
        <h2 class="text-xl font-semibold mb-4 text-center text-gray-700">
          Instructor Panel - Setup Game
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label
              for="endowment"
              class="block text-sm font-medium text-gray-700"
              >Endowment per Round:</label
            >
            <input
              type="number"
              id="endowment"
              value="20"
              min="0"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            />
          </div>
          <div>
            <label
              for="mpcr"
              class="block text-sm font-medium text-gray-700"
              >Marginal Per Capita Return (MPCR):</label
            >
            <input
              type="number"
              step="0.01"
              id="mpcr"
              value="0.4"
              min="0"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            />
          </div>
          <div>
            <label
              for="total-rounds"
              class="block text-sm font-medium text-gray-700"
              >Total Rounds:</label
            >
            <input
              type="number"
              id="total-rounds"
              value="10"
              min="1"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            />
          </div>
          <div>
            <label
              for="punishment-round"
              class="block text-sm font-medium text-gray-700"
              >Punishment Starts Round (0=off):</label
            >
            <input
              type="number"
              id="punishment-round"
              value="0"
              min="0"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            />
          </div>
          <div>
            <label
              for="punishment-cost"
              class="block text-sm font-medium text-gray-700"
              >Punishment Cost (per point):</label
            >
            <input
              type="number"
              id="punishment-cost"
              value="1"
              min="0"
              step="0.1"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            />
          </div>
          <div>
            <label
              for="punishment-effect"
              class="block text-sm font-medium text-gray-700"
              >Punishment Effect (per point):</label
            >
            <input
              type="number"
              id="punishment-effect"
              value="3"
              min="0"
              step="0.1"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            />
          </div>
          <div>
            <label
              for="max-punishment"
              class="block text-sm font-medium text-gray-700"
              >Max Punishment per Player:</label
            >
            <input
              type="number"
              id="max-punishment"
              value="10"
              min="0"
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            />
          </div>
        </div>
        <button
          id="start-game"
          class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-150"
        >
          Start Game with Connected Students
        </button>
        <div class="mt-4">
          <h3 class="text-lg font-medium text-gray-800">
            Connected Students (<span id="student-count">0</span>):
          </h3>
          <ul
            id="student-list"
            class="list-disc list-inside text-gray-600 max-h-40 overflow-y-auto border p-2 rounded mt-2"
          >
            <!-- Student names will appear here -->
          </ul>
        </div>
      </div>

      <!-- ===== Instructor View: Game Running ===== -->
      <div
        id="instructor-game"
        class="hidden"
      >
        <h2 class="text-xl font-semibold mb-4 text-center text-gray-700">
          Instructor Panel - Game Running
        </h2>
        <div class="text-center mb-4 p-4 bg-indigo-100 rounded">
          <p class="text-lg font-medium text-indigo-800">
            Round <span id="instructor-current-round">1</span> of
            <span id="instructor-total-rounds">10</span>
          </p>
          <p class="text-md text-indigo-600">
            Status:
            <span id="instructor-game-status"
              >Waiting for contributions...</span
            >
          </p>
        </div>
        <div class="mb-4">
          <h3 class="text-lg font-medium text-gray-800 mb-2">
            Average Contribution per Round:
          </h3>
          <!-- Chart Canvas Container -->
          <div
            id="chart-container"
            class="relative border rounded p-2 h-64 bg-gray-50"
          >
            <canvas id="instructorChartCanvas"></canvas>
            <!-- <<< CANVAS FOR CHART -->
          </div>
        </div>
        <div class="flex justify-center space-x-4">
          <!-- Instructor control buttons -->
          <button
            id="next-stage-button"
            disabled
            class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition duration-150 opacity-50 cursor-not-allowed"
          >
            (Adv Stage - Manual)
          </button>
          <button
            id="next-round-button"
            disabled
            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150 opacity-50 cursor-not-allowed"
          >
            Start Next Round
          </button>
        </div>
        <div class="mt-4">
          <h3 class="text-lg font-medium text-gray-800">
            Group Details (Live - optional):
          </h3>
          <div
            id="instructor-group-details"
            class="text-sm text-gray-600 max-h-40 overflow-y-auto border p-2 rounded mt-2"
          >
            Waiting for game to start...
          </div>
        </div>
      </div>

      <!-- ===== Student View: Joining ===== -->
      <div
        id="student-join"
        class="hidden text-center"
      >
        <h2 class="text-xl font-semibold mb-4 text-gray-700">Join Game</h2>
        <label
          for="student-name"
          class="block text-sm font-medium text-gray-700 mb-1"
          >Enter Your Name:</label
        >
        <input
          type="text"
          id="student-name"
          placeholder="e.g., Alex Smith"
          class="mb-4 block w-full max-w-xs mx-auto px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
        />
        <button
          id="submit-student-name"
          class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150"
        >
          Join
        </button>
        <p
          id="student-wait-message"
          class="mt-4 text-gray-600 hidden"
        >
          Waiting for instructor to start the game...
        </p>
      </div>

      <!-- ===== Student View: Game Play ===== -->
      <div
        id="student-game"
        class="hidden"
      >
        <div class="flex justify-between items-center mb-3 pb-2 border-b">
          <h2 class="text-xl font-semibold text-gray-700">
            Round <span id="student-current-round">1</span>/<span
              id="student-total-rounds"
              >10</span
            >
          </h2>
          <div class="text-right">
            <p class="text-sm text-gray-600">
              Your Endowment:
              <span
                id="student-endowment"
                class="font-medium"
                >20</span
              >
              tokens
            </p>
            <p class="text-sm text-gray-600">
              Total Earned:
              <span
                id="student-total-earned"
                class="font-medium"
                >0</span
              >
              tokens
            </p>
          </div>
        </div>

        <!-- Contribution Stage -->
        <div id="contribution-stage">
          <p class="mb-3 text-gray-700">
            Decide how many tokens (0 -
            <span id="student-max-contribution">20</span>) to contribute to the
            group project:
          </p>
          <input
            type="number"
            id="contribution-amount"
            min="0"
            max="20"
            placeholder="0"
            class="block w-full mb-4 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-center text-lg"
          />
          <button
            id="submit-contribution"
            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-150"
          >
            Submit Contribution
          </button>
          <p
            id="contribution-wait"
            class="mt-3 text-center text-gray-500 hidden"
          >
            Contribution submitted. Waiting for others...
          </p>
        </div>

        <!-- Punishment Stage -->
        <div
          id="punishment-stage"
          class="hidden"
        >
          <h3 class="text-lg font-semibold mb-3 text-center text-indigo-700">
            Punishment Stage
          </h3>
          <p class="text-sm text-gray-600 mb-1">
            You earned <strong id="round-earnings-pre-punish">X</strong> tokens
            this round (before punishment).
          </p>
          <p class="text-sm text-gray-600 mb-3">
            You can spend up to
            <strong id="max-punish-per-target">Z</strong> points per person to
            punish others (cost: <span id="punish-cost-display">1</span>,
            effect: <span id="punish-effect-display">3</span>). Total cost
            cannot exceed earnings.
          </p>
          <div
            id="punishment-options"
            class="space-y-3 mb-4"
          >
            <!-- Punishment inputs will be added here by JS -->
          </div>
          <button
            id="submit-punishment"
            class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-150"
          >
            Submit Punishments (even if all are 0)
          </button>
          <p
            id="punishment-wait"
            class="mt-3 text-center text-gray-500 hidden"
          >
            Punishments submitted. Waiting for others...
          </p>
        </div>

        <!-- Feedback Stage -->
        <div
          id="feedback-stage"
          class="hidden mt-4 p-4 border rounded bg-gray-50"
        >
          <h3 class="text-lg font-semibold mb-3 text-center text-green-700">
            Round Results
          </h3>
          <div class="space-y-1 text-sm">
            <p>
              Your contribution:
              <strong id="feedback-your-contribution"></strong> tokens
            </p>
            <p>
              Group total contribution:
              <strong id="feedback-group-contribution"></strong> tokens
            </p>
            <p>Tokens kept: <strong id="feedback-tokens-kept"></strong></p>
            <p>
              Earnings from project:
              <strong id="feedback-project-earnings"></strong>
            </p>
            <p class="border-t pt-1 mt-1">
              Earnings before punishment:
              <strong id="feedback-pre-punish-earnings"></strong>
            </p>
            <!-- Punishment Feedback -->
            <div
              id="punishment-feedback"
              class="hidden text-red-600 border-t pt-1 mt-1"
            >
              <p>
                Punishment cost (spent):
                <strong id="feedback-punish-cost"></strong> tokens
              </p>
              <p>
                Punishment received (loss):
                <strong id="feedback-punish-received"></strong> tokens
              </p>
            </div>
            <p class="font-bold text-base border-t pt-1 mt-1">
              Final earnings this round:
              <strong id="feedback-final-earnings"></strong> tokens
            </p>
          </div>
          <p
            id="feedback-wait"
            class="mt-3 text-center text-gray-500 hidden"
          >
            Waiting for instructor to start next round...
          </p>
        </div>
      </div>

      <!-- ===== Game Over View ===== -->
      <div
        id="game-over"
        class="hidden text-center"
      >
        <h2 class="text-2xl font-bold mb-4 text-gray-700">Game Over!</h2>
        <p class="text-lg text-gray-600 mb-6">
          Your final score:
          <strong
            id="final-score"
            class="text-xl text-blue-600"
            >0</strong
          >
          tokens
        </p>
        <p class="text-gray-500">Thank you for playing.</p>
        <!-- Instructor final results -->
        <div
          id="instructor-final-results"
          class="mt-6 hidden"
        >
          <h3 class="text-lg font-medium text-gray-800">Final Game Summary:</h3>
          <!-- Final Chart Container -->
          <div
            id="final-chart-container"
            class="relative border rounded p-2 h-64 bg-gray-50 mt-2"
          >
            <canvas id="instructorFinalChartCanvas"></canvas>
            <!-- <<< CANVAS FOR FINAL CHART -->
          </div>
        </div>
      </div>
    </div>
    <!-- end #app-container -->

    <!-- Load Chart.js *before* client.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Link to Client-side JavaScript -->
    <script src="client.js"></script>
  </body>
</html>
